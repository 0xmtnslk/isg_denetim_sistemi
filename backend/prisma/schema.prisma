// Prisma Schema - İSG Denetim Sistemi
// PostgreSQL veritabanı için

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// KULLANICI YÖNETİMİ
// ========================================

enum UserRole {
  ADMIN           // Tüm yetkiler
  ISG_UZMANI     // Denetim + Rapor
  DENETCI        // Sadece denetim
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String   // bcrypt hash
  fullName  String
  email     String   @unique
  role      UserRole @default(DENETCI)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // İlişkiler
  audits    Audit[]  // Yapılan denetimler
  
  @@map("users")
}

// ========================================
// GRUP VE TESİS YÖNETİMİ
// ========================================

model Group {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // İlişkiler
  facilities  Facility[]
  
  @@map("groups")
}

model Facility {
  id          Int      @id @default(autoincrement())
  name        String
  address     String?
  city        String?
  groupId     Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // İlişkiler
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  audits      Audit[]
  
  @@map("facilities")
}

// ========================================
// SORU HAVUZU
// ========================================

model Section {
  id          Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  order       Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // İlişkiler
  categories  Category[]
  
  @@map("sections")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  sectionId   Int
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // İlişkiler
  section     Section   @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  questions   Question[]
  
  @@map("categories")
}

model Question {
  id             Int       @id @default(autoincrement())
  text           String
  twScore        Int       // 1-10 arası önem derecesi
  categoryId     Int
  order          Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // İlişkiler
  category       Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  templateQuestions TemplateQuestion[]
  auditAnswers   AuditAnswer[]
  
  @@map("questions")
}

// ========================================
// DENETİM ŞABLONLARİ
// ========================================

model Template {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // İlişkiler
  questions   TemplateQuestion[]
  audits      Audit[]
  
  @@map("templates")
}

model TemplateQuestion {
  id          Int      @id @default(autoincrement())
  templateId  Int
  questionId  Int
  order       Int      @default(0)
  
  // İlişkiler
  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  @@unique([templateId, questionId])
  @@map("template_questions")
}

// ========================================
// DENETİMLER
// ========================================

enum AuditStatus {
  DRAFT       // Taslak
  COMPLETED   // Tamamlandı
}

model Audit {
  id          Int         @id @default(autoincrement())
  facilityId  Int
  templateId  Int
  userId      Int         // Denetçi
  auditDate   DateTime
  status      AuditStatus @default(DRAFT)
  
  // Skor bilgileri (cache olarak saklanır)
  totalScore  Float?      // Genel skor (%)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // İlişkiler
  facility    Facility    @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  template    Template    @relation(fields: [templateId], references: [id], onDelete: Cascade)
  auditor     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers     AuditAnswer[]
  
  @@map("audits")
}

// ========================================
// DENETİM CEVAPLARI
// ========================================

enum AnswerType {
  KARSILYOR          // 3 puan
  KISMEN_KARSILYOR   // 1 puan
  KARSILAMIYOR       // 0 puan
  KAPSAM_DISI        // Puanlamaya dahil değil
}

model AuditAnswer {
  id          Int        @id @default(autoincrement())
  auditId     Int
  questionId  Int
  answerType  AnswerType
  explanation String?    // Açıklama (Kısmen/Karşılamıyor için zorunlu)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  // İlişkiler
  audit       Audit      @relation(fields: [auditId], references: [id], onDelete: Cascade)
  question    Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  photos      Photo[]
  
  @@unique([auditId, questionId])
  @@map("audit_answers")
}

// ========================================
// FOTOĞRAFLAR
// ========================================

model Photo {
  id            Int         @id @default(autoincrement())
  auditAnswerId Int
  filename      String
  originalName  String
  mimeType      String
  size          Int         // bytes
  path          String      // Sunucudaki yol
  createdAt     DateTime    @default(now())
  
  // İlişkiler
  auditAnswer   AuditAnswer @relation(fields: [auditAnswerId], references: [id], onDelete: Cascade)
  
  @@map("photos")
}
